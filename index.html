<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eventi Storici</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Collegamento al file CSS esterno -->
  </head>
  <body>
    <div class="container">
      <h1>Evento Storico del Giorno</h1>
      <p>Data odierna: <span id="dataOdierna"></span></p>
      <!-- Elemento per visualizzare la data odierna -->
      <div id="evento">
        <!-- Il contenuto verrà caricato dinamicamente qui -->
      </div>
      <div>
        <button onclick="scopriDiPiu()">Scopri di più</button>
      </div>
      <div id="chatBot">
        <!-- Qui il chatBot risponderà alle tue curiosità -->
      </div>
    </div>

    <script>
      // Funzione per ottenere la data odierna nel formato "MM-DD"
      function getDataOdierna() {
        const oggi = new Date();
        const mese = String(oggi.getMonth() + 1).padStart(2, "0");
        const giorno = String(oggi.getDate()).padStart(2, "0");
        return `${mese}-${giorno}`;
      }

      //richiamo la funzione per avere la data corrente
      const dataOdierna = getDataOdierna();
      //la visualizzo a video
      document.getElementById("dataOdierna").textContent = dataOdierna;

      //funzione lanciata all'avvio della pagina per ricercare l'evento del giorno
      function caricareEventoStorico() {
        //creo un'intestazione formato json per la post
        const myHeader = new Headers();
        myHeader.append("Content-type", "application/json");

        //variabili odierne
        const [meseOdierno, giornoOdierno] = getDataOdierna().split("-");

        //creo il body della richiesta post
        const raw = JSON.stringify({
          mese: meseOdierno,
          giorno: giornoOdierno,
        });

        //scrivo le opzioni della richiesta
        const requestOptions = {
          method: "POST",
          headers: myHeader,
          body: raw,
          redirect: "follow",
        };

        // Eseguire una richiesta HTTP POST per ottenere l'evento storico
        fetch("http://localhost:3000/evento", requestOptions)
          .then((response) => {
            //se la risposta del server è negativa
            if (!response.ok) {
              throw new Error("Errore nel caricamento dell'evento storico.");
            }
            // se la risposta del server è positiva
            return response.json();
          })
          //leggo i dati della risposta del server
          .then((results) => {
            // Aggiunto per debug, controllo la riposta del server
            console.log("Dati ricevuti:", results);
            //la stampo a video
            const eventoDiv = document.getElementById("evento");
            eventoDiv.innerHTML = results.evento;
          })
          //se avviene un errore nella richiesta
          .catch((error) => {
            console.error("Si è verificato un errore:", error);
          });
      }

      function scopriDiPiu() {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
          question: document.getElementById("evento").textContent,
        });

        const requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("http://localhost:3000/chat", requestOptions)
        .then((response) => {
            //se la risposta del server è negativa
            if (!response.ok) {
              throw new Error("Errore nel caricamento dell'evento storico.");
            }
            // se la risposta del server è positiva
            return response.json();
          })
          .then((results) => {
            // Aggiunto per debug, controllo la riposta del server
            console.log("Dati ricevuti:", results.response);
            //la stampo a video
            const chatBot = document.getElementById("chatBot");
            chatBot.innerHTML = results.response;
          })
          .catch((error) => {
            console.error("Si è verificato un errore:", error);
          });
      }
      // Chiamare la funzione per caricare l'evento storico all'avvio della pagina
      window.onload = caricareEventoStorico();
    </script>
  </body>
</html>
